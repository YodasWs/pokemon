<!DOCTYPE html>
<html lang="en-us">
<head>
<meta charset="utf-8"/>
<title>Map Builder</title>
<link rel="stylesheet" href="main.css" />
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
<script>
String.prototype.trim=function(c){c=c||"\\s\uFEFF\xA0";return this.replace(new RegExp('^['+c+']+|['+c+']+$','g'),'')};
var map = {
	"cities":[
		{
			"id":"CLT",
			"size":20
		},
		{
			"id":"UNCC",
			"size":10
		},
		{
			"id":"Northlake Mall",
			"size":5
		},
		{
			"id":"Huntersville",
			"size":5
		},
		{
			"id":"Northcross",
			"size":5
		},
		{
			"id":"Lowesville",
			"size":5
		},
		{
			"id":"Matthews",
			"size":10
		},
		{
			"id":"Birkdale",
			"size":5
		},
		{
			"id":"Cornelius",
			"size":10
		},
		{
			"id":"Davidson",
			"size":5
		},
		{
			"id":"Pineville",
			"size":5
		},
		{
			"id":"Mooresville",
			"size":5
		}
	],
	"routes":[
		{
			"name":"Route 21",
			"cardinality":["s","n"],
			"points":["CLT","Northlake Mall"]
		},
		{
			"name":"Catawba Ave",
			"cardinality":["s","n"],
			"points":["Birkdale","Cornelius"]
		},
		{
			"name":"Route 115",
			"cardinality":["n","s"],
			"points":["Huntersville","Northlake Mall"]
		},
		{
			"name":"Route 24",
			"cardinality":["e","w"],
			"points":["UNCC","Northlake Mall"]
		},
		{
			"name":"Route 29",
			"cardinality":["sw","ne"],
			"points":["CLT","UNCC"]
		},
		{
			"name":"Route 115",
			"cardinality":["s","n"],
			"points":["Huntersville","Northcross"]
		},
		{
			"name":"Route 115",
			"cardinality":["n","s"],
			"points":["Cornelius","Northcross"]
		},
		{
			"name":"Route 73",
			"cardinality":["w","e"],
			"points":["Birkdale","Northcross"]
		},
		{
			"name":"Route 73",
			"cardinality":["e","w"],
			"points":["Birkdale","Lowesville"]
		},
		{
			"name":"Route 16",
			"cardinality":["se","nw"],
			"points":["CLT","Lowesville"]
		},
		{
			"name":"Route 115",
			"cardinality":["s","n"],
			"points":["Cornelius","Davidson"]
		},
		{
			"name":"Sugar Creek Greenway",
			"cardinality":["n","s"],
			"points":["CLT","Pineville"]
		},
		{
			"name":"Route 74",
			"cardinality":["nw","se"],
			"points":["CLT","Matthews"]
		},
		{
			"name":"Route 51",
			"cardinality":["w","e"],
			"points":["Pineville","Matthews"]
		},
		{
			"name":"Route 115",
			"cardinality":["s","n"],
			"points":["Davidson","Mooresville"]
		}
	],
	"visited":[
		"Cornelius","UNCC","Northlake Mall","Lowesville","Davidson","Matthews","Huntersville","CLT","Birkdale"
	]
},
svg = {
	path: function() {
		return document.createElementNS("http://www.w3.org/2000/svg", "path")
	},
	circle: function(x, y, r) {
		var e = document.createElementNS("http://www.w3.org/2000/svg", "circle")
		if (typeof x !== 'undefined' && x !== null) e.setAttribute("cx", x)
		if (typeof y !== 'undefined' && y !== null) e.setAttribute("cy", y)
		if (typeof r !== 'undefined' && r !== null) e.setAttribute("r", r)
		return e
	}
},
getAngleRange = function(cardinality) {
	switch (cardinality) {
	case 'ew':
	case 'ns':
	}
},
fitAngleRange = function(angle, cardinality) {
	// TODO: Need to fit angle within range
	var dirs = [
		'e',
		'se',
		's',
		'sw',
		'w',
		'nw',
		'n',
		'ne',
	],
	min = dirs.indexOf(cardinality) * 45 - 30,
	max = dirs.indexOf(cardinality) * 45 + 30,
	i = 0;
	while (min > angle || max < angle || i++ < 10000) {
		if (min > angle) {
			angle += 45
		}
		if (max < angle) {
			angle -= 45
		}
	}
	return angle
}
map.visited.indexOf =
map.cities.indexOf = function(id) {
	var index = -1
	for (var i=0; i<this.length; i++) {
		if ((this[i].id && this[i].id == id) || this[i] == id) {
			index = i
			break
		}
	}
	return index
}
map.citiesAreJoined = function(a, b) {
	if (typeof b === 'object' && b.id) {
		b = b.id
	}
	var joined = false;
	;(map.routes.from(a)).forEach(function(route) {
		if (route.points.indexOf(b) > -1) {
			joined = true;
		}
	});
	return joined;
}
map.cities.indexOf.bind(map.cities)
map.routes.from = function(point) {
	if (typeof point === 'object' && point.id) {
		point = point.id
	}
	var arrReturn = []
	for (var i=0; i<this.length; i++) {
		if (this[i].points.indexOf(point) > -1) arrReturn.push(this[i])
	}
	return arrReturn
}
Array.prototype.unique = function() {
	var arr = [];
	for (var i=0; i<this.length; i++) {
		if (arr.indexOf(this[i]) == -1) {
			arr.push(this[i]);
		}
	}
	return arr;
}
map.routes.from.bind(map.routes)
$(document).ready(function() {
	svg.root = document.getElementsByTagNameNS("http://www.w3.org/2000/svg", 'svg')[0]
	var x = 250, y = 250
	// Sort Cities Visited
console.log(map.visited);
	map.visited = map.visited.sort(function(a, b) {
console.log(a, b)
console.log(map.visited.indexOf(a), map.visited.indexOf(b))
		// Keep Front City in Place
		if (map.visited.indexOf(a) === 0) {
			return -1;
		}
		if (map.visited.indexOf(b) === 0) {
			return 1;
		}
		// TODO: Find if Cities Connected to First City
		// Lower Cities Further Away
		indices = [a, b].map(function(city) {
			for (var j=0; j<map.visited.length; j++) {
				if (map.citiesAreJoined(map.visited[j], city)) {
					return j
				}
			}
			return false;
		})
console.log(indices, indices[0] - indices[1])
		if (indices[0] === false && indices[1] !== false) return 1
		if (indices[0] !== false && indices[1] === false) return -1
		return indices[0] - indices[1];
	})
console.log(map.visited);
	// Remove Cities Not Connected
	var toRemove
	do {
		toRemove = []
		map.visited.forEach(function(city) {
			var i = map.visited.indexOf(city)
			if (i === 0) return
			var connected = false
			for (var j=0; j<i; j++) {
				if (map.citiesAreJoined(map.visited[j], city)) {
					connected = true;
					break;
				}
			}
			if (!connected) {
				toRemove.push(i)
			}
		})
		toRemove.forEach(function(i) {
			map.visited.splice(i, 1)
		})
	} while (toRemove.length)
console.log(map.visited);
	// Fill Out Visited City Information
	map.visited.forEach(function(city, i) {
		map.visited[i] = map.cities[map.cities.indexOf(city)]
	})
	// Place Cities on Map
	map.visited.forEach(function(city) {
		var routes = map.routes.from(city),
			connectedCities = [],
			citiesToDraw = []
			angle = 360
		// Add Circle for City to Map
		if (!city.circle) {
			city.circle = svg.circle(x, y, city.size)
			city.circle.setAttribute("title", city.id)
			svg.root.appendChild(city.circle)
		} else {
			x = city.circle.getAttribute('cx')
			y = city.circle.getAttribute('cy')
		}
		// Get List of Cities to add vs already added
		routes.forEach(function(route) {
			route.points.forEach(function(pnt, j) {
				if (pnt == city.id) return
				var i = map.cities.indexOf(pnt)
				if (map.cities[i].circle) {
					// City already drawn
					connectedCities.push(map.cities[i])
				} else if (citiesToDraw.indexOf(pnt) == -1) {
					// Need to draw City
					citiesToDraw.push({
						cardinality:route.cardinality[j],
						city:pnt
					})
				}
			})
		})
		// Need to make sure we don't overlap existing routes!
		var angles = []
		connectedCities.forEach(function(cc) {
			angles.push(
				Math.round(Math.atan(
					(cc.circle.getAttribute("cy") - y)
					/
					(cc.circle.getAttribute("cx") - x)
				) * 180 / Math.PI)
			)
		})
		// Draw new Connected Cities
		var numSpokes = Math.max(citiesToDraw.length + connectedCities.length, 3)
		citiesToDraw.forEach(function(pnt) {
			var cc = map.cities.indexOf(pnt.city),
				cardinality = pnt.cardinality,
				radius = Math.max(city.size, Number.parseFloat(map.cities[cc].size)) * 5
			do {
				angle -= 360 / numSpokes
				if (angle < -30) angle += 360
				if (angle > 345) angle -= 360
			} while (angles.indexOf(angle) > -1)
			angle = fitAngleRange(angle, cardinality)
			map.cities[cc].circle = svg.circle(
				Number.parseFloat((radius * Math.cos(angle * Math.PI / 180)).toFixed(4)) + Number.parseFloat(x),
				Number.parseFloat((radius * Math.sin(angle * Math.PI / 180)).toFixed(4)) + Number.parseFloat(y),
				map.cities[cc].size
			)
			map.cities[cc].circle.setAttribute("title", map.cities[cc].id)
			svg.root.appendChild(map.cities[cc].circle)
		})
	})
	// Draw Routes between Cities
	map.routes.forEach(function(route) {
		if (!map.cities[map.cities.indexOf(route.points[0])].circle) return
		if (!map.cities[map.cities.indexOf(route.points[1])].circle) return
		var routeVisible = false
		route.points.forEach(function(pnt){
			if (map.visited.indexOf(pnt) > -1)
				routeVisible = true
		})
		if (!routeVisible) return
		path = svg.path()
		path.setAttribute('d', 'M' + [
				[
					map.cities[map.cities.indexOf(route.points[0])].circle.getAttribute("cx"),
					map.cities[map.cities.indexOf(route.points[0])].circle.getAttribute("cy")
				],
				[
					map.cities[map.cities.indexOf(route.points[1])].circle.getAttribute("cx"),
					map.cities[map.cities.indexOf(route.points[1])].circle.getAttribute("cy")
				]
			].map(function(point) {
				return point.join(',')
			}).join('L').trim('L')
		)
		svg.root.insertBefore(path, svg.root.childNodes[0])
	})
})
</script>
</head>
<body>
<h1>Map Builder</h1>
<svg xmlns="http://www.w3.org/2000/svg" version="1.1"></svg>
</body>
</html>
